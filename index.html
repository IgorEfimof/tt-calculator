<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <style>
        :root {
            --primary: #E53935;
            --secondary: #D32F2F;
            --bg: #f5f7fa;
            --card: #ffffff;
            --text: #2c3e50;
            --highlight: #FFF9C4;
            --positive: #4CAF50;
            --negative: #F44336;
            --dark-bg: #1a1a1a;
            --dark-card: #2d2d2d;
            --dark-text: #e0e0e0;
        }
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }
        html, body {
            height: 100%;
            overflow: hidden;
            touch-action: manipulation;
            -webkit-text-size-adjust: 100%;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            font-size: 14px;
        }
        body.dark-mode {
            background: var(--dark-bg);
            color: var(--dark-text);
        }
        .container {
            max-width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: column;
            background: var(--card);
            padding: 0;
        }
        .dark-mode .container {
            background: var(--dark-card);
        }
        .header {
            background: var(--primary);
            color: white;
            padding: 8px 15px;
            text-align: center;
            font-weight: 600;
            font-size: 16px;
            position: relative;
        }
        .theme-toggle, .mode-toggle {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
        }
        .theme-toggle { left: 5px; }
        .mode-toggle { right: 5px; }
        .input-section {
            padding: 8px;
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        .input-row {
            display: flex;
            margin-bottom: 6px;
            align-items: center;
        }
        .input-group {
            flex: 1;
            margin: 0 4px;
            position: relative;
        }
        .input-group label {
            display: block;
            margin-bottom: 3px;
            font-weight: 500;
            font-size: 12px;
        }
        .dark-mode .input-group label {
            color: var(--dark-text);
        }
        .custom-input {
            width: 100%;
            padding: 8px 8px 8px 20px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
            background: #f9f9f9;
            caret-color: transparent;
            text-align: right;
        }
        .dark-mode .custom-input {
            background: #3d3d3d;
            border-color: #555;
            color: var(--dark-text);
        }
        .custom-input:focus {
            outline: none;
            border: 2px solid var(--primary);
            background: var(--highlight);
        }
        .dark-mode .custom-input:focus {
            background: #4d4d4d;
        }
        .decimal-point {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
        }
        .btn {
            padding: 10px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 500;
            background: var(--primary);
            color: white;
            cursor: pointer;
            width: 100%;
            margin: 8px 0;
        }
        .results {
            background: #f8f9fa;
            border-radius: 6px;
            padding: 8px;
            margin-top: 6px;
            border-left: 3px solid var(--primary);
            font-size: 12px;
        }
        .dark-mode .results {
            background: #333;
            color: var(--dark-text);
        }
        .value-positive {
            color: var(--positive);
            font-weight: bold;
        }
        .value-negative {
            color: var(--negative);
        }
        .keyboard {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 4px;
            padding: 6px;
            background: #f0f0f0;
            border-top: 1px solid #ddd;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 100;
        }
        .dark-mode .keyboard {
            background: #333;
            border-color: #555;
        }
        .key {
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 8px;
            font-size: 14px;
            text-align: center;
            cursor: pointer;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .dark-mode .key {
            background: #444;
            border-color: #666;
            color: var(--dark-text);
        }
        .key-enter {
            background: var(--primary);
            color: white;
            grid-column: span 2;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 6px;
            font-size: 11px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 4px;
            text-align: left;
        }
        .dark-mode th, .dark-mode td {
            border-color: #555;
        }
        th {
            background-color: #f2f2f2;
        }
        .dark-mode th {
            background-color: #444;
            color: var(--dark-text);
        }
        .dark-mode td {
            background-color: #3d3d3d;
        }
        .section-title {
            margin: 8px 0 4px;
            color: var(--primary);
            padding-bottom: 3px;
            border-bottom: 1px solid #eee;
            font-size: 13px;
        }
        .dark-mode .section-title {
            border-color: #555;
        }
        .change-positive {
            color: var(--positive);
            font-weight: bold;
        }
        .change-negative {
            color: var(--negative);
            font-weight: bold;
        }
        .best-value {
            background-color: #FFF9C4;
        }
        .dark-mode .best-value {
            background-color: #5d4037;
        }
        .comparison-cell {
            display: flex;
            justify-content: space-between;
        }
        .prematch-value {
            color: #888;
            font-size: 10px;
        }
        .live-value {
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <button class="theme-toggle" id="themeToggle">🌙</button>
            TT Value Analyzer PRO
            <button class="mode-toggle" id="modeToggle">Прематч</button>
        </div>
        
        <div class="input-section" id="inputSection">
            <div id="prematchSection">
                <div class="input-row">
                    <div class="input-group">
                        <label>П1:</label>
                        <span class="decimal-point">.</span>
                        <input type="text" class="custom-input" id="odds1" placeholder="1.90" inputmode="none">
                    </div>
                    <div class="input-group">
                        <label>П2:</label>
                        <span class="decimal-point">.</span>
                        <input type="text" class="custom-input" id="odds2" placeholder="1.90" inputmode="none">
                    </div>
                </div>
                
                <h3 class="section-title">Тоталы (прематч)</h3>
                
                <div class="input-row">
                    <div class="input-group">
                        <label>Over 17.5:</label>
                        <span class="decimal-point">.</span>
                        <input type="text" class="custom-input" id="over17" placeholder="1.85" inputmode="none">
                    </div>
                    <div class="input-group">
                        <label>Under 17.5:</label>
                        <span class="decimal-point">.</span>
                        <input type="text" class="custom-input" id="under17" placeholder="1.95" inputmode="none">
                    </div>
                </div>
                
                <div class="input-row">
                    <div class="input-group">
                        <label>Over 18.5:</label>
                        <span class="decimal-point">.</span>
                        <input type="text" class="custom-input" id="over18" placeholder="1.85" inputmode="none">
                    </div>
                    <div class="input-group">
                        <label>Under 18.5:</label>
                        <span class="decimal-point">.</span>
                        <input type="text" class="custom-input" id="under18" placeholder="1.95" inputmode="none">
                    </div>
                </div>
                
                <div class="input-row">
                    <div class="input-group">
                        <label>Over 19.5:</label>
                        <span class="decimal-point">.</span>
                        <input type="text" class="custom-input" id="over19" placeholder="1.85" inputmode="none">
                    </div>
                    <div class="input-group">
                        <label>Under 19.5:</label>
                        <span class="decimal-point">.</span>
                        <input type="text" class="custom-input" id="under19" placeholder="1.95" inputmode="none">
                    </div>
                </div>
            </div>
            
            <div id="liveSection" style="display: none;">
                <div class="input-group">
                    <label>Текущий гейм:</label>
                    <input type="text" class="custom-input" id="currentGame" placeholder="5" inputmode="none">
                </div>
                
                <h3 class="section-title">Тоталы (лайв)</h3>
                
                <div class="input-row">
                    <div class="input-group">
                        <label>Over 17.5:</label>
                        <span class="decimal-point">.</span>
                        <input type="text" class="custom-input" id="live_over17" placeholder="1.85" inputmode="none">
                    </div>
                    <div class="input-group">
                        <label>Under 17.5:</label>
                        <span class="decimal-point">.</span>
                        <input type="text" class="custom-input" id="live_under17" placeholder="1.95" inputmode="none">
                    </div>
                </div>
                
                <div class="input-row">
                    <div class="input-group">
                        <label>Over 18.5:</label>
                        <span class="decimal-point">.</span>
                        <input type="text" class="custom-input" id="live_over18" placeholder="1.85" inputmode="none">
                    </div>
                    <div class="input-group">
                        <label>Under 18.5:</label>
                        <span class="decimal-point">.</span>
                        <input type="text" class="custom-input" id="live_under18" placeholder="1.95" inputmode="none">
                    </div>
                </div>
                
                <div class="input-row">
                    <div class="input-group">
                        <label>Over 19.5:</label>
                        <span class="decimal-point">.</span>
                        <input type="text" class="custom-input" id="live_over19" placeholder="1.85" inputmode="none">
                    </div>
                    <div class="input-group">
                        <label>Under 19.5:</label>
                        <span class="decimal-point">.</span>
                        <input type="text" class="custom-input" id="live_under19" placeholder="1.95" inputmode="none">
                    </div>
                </div>
            </div>
            
            <button class="btn" onclick="calculate()">Анализировать</button>
            
            <div class="results" id="result" style="display: none;">
                <div id="output"></div>
                <table id="resultsTable">
                    <tr>
                        <th>Рынок</th>
                        <th>Коэф.</th>
                        <th>Вероятность</th>
                        <th>Value</th>
                        <th>Динамика</th>
                    </tr>
                </table>
            </div>
        </div>
        
        <div class="keyboard" id="keyboard" style="display: none;">
            <div class="key" onclick="pressKey('1')">1</div>
            <div class="key" onclick="pressKey('2')">2</div>
            <div class="key" onclick="pressKey('3')">3</div>
            <div class="key" onclick="pressKey('⌫')">⌫</div>
            <div class="key" onclick="pressKey('4')">4</div>
            <div class="key" onclick="pressKey('5')">5</div>
            <div class="key" onclick="pressKey('6')">6</div>
            <div class="key" onclick="pressKey('.')">.</div>
            <div class="key" onclick="pressKey('7')">7</div>
            <div class="key" onclick="pressKey('8')">8</div>
            <div class="key" onclick="pressKey('9')">9</div>
            <div class="key" onclick="pressKey('0')">0</div>
            <div class="key-enter" onclick="hideKeyboard()">Готово</div>
        </div>
    </div>

    <script>
        // Инициализация темы
        const themeToggle = document.getElementById('themeToggle');
        themeToggle.addEventListener('click', () => {
            document.body.classList.toggle('dark-mode');
            themeToggle.textContent = document.body.classList.contains('dark-mode') ? '☀️' : '🌙';
        });

        // Переключение между прематч и лайв режимами
        const modeToggle = document.getElementById('modeToggle');
        const prematchSection = document.getElementById('prematchSection');
        const liveSection = document.getElementById('liveSection');
        
        modeToggle.addEventListener('click', () => {
            if (prematchSection.style.display === 'none') {
                prematchSection.style.display = 'block';
                liveSection.style.display = 'none';
                modeToggle.textContent = 'Прематч';
            } else {
                prematchSection.style.display = 'none';
                liveSection.style.display = 'block';
                modeToggle.textContent = 'Лайв';
            }
        });

        // Отключаем системную клавиатуру
        document.addEventListener('touchstart', function(e) {
            if (e.target.tagName === 'INPUT' && e.target.getAttribute('inputmode') === 'none') {
                e.preventDefault();
                showKeyboard();
                e.target.focus();
            }
        }, { passive: false });
        
        let activeInput = null;
        const inputs = document.querySelectorAll('.custom-input');
        
        function showKeyboard() {
            const keyboard = document.getElementById('keyboard');
            keyboard.style.display = 'grid';
        }
        
        function pressKey(key) {
            if (!activeInput) return;
            
            if (key === '⌫') {
                const currentValue = activeInput.value;
                if (currentValue.length > 0) {
                    activeInput.value = currentValue.slice(0, -1);
                    if (activeInput.value === '.') {
                        activeInput.value = '';
                    }
                }
                return;
            }
            
            if (/^\d$/.test(key)) {
                const currentValue = activeInput.value;
                
                if (currentValue === '') {
                    activeInput.value = key + '.';
                } 
                else if (currentValue.includes('.') && currentValue.split('.')[1].length < 2) {
                    activeInput.value += key;
                    
                    if (currentValue.split('.')[1].length === 1) {
                        moveToNextField();
                    }
                }
                else if (!currentValue.includes('.') && currentValue.length < 3) {
                    activeInput.value += key;
                    if (currentValue.length === 1) {
                        activeInput.value += '.';
                    }
                }
            }
            
            if (key === '.' && !activeInput.value.includes('.')) {
                if (activeInput.value === '') {
                    activeInput.value = '0.';
                } else {
                    activeInput.value += '.';
                }
            }
        }
        
        function moveToNextField() {
            const allInputs = Array.from(document.querySelectorAll('.custom-input'));
            const currentIndex = allInputs.indexOf(activeInput);
            
            if (currentIndex < allInputs.length - 1) {
                setTimeout(() => {
                    allInputs[currentIndex + 1].focus();
                }, 50);
            } else {
                hideKeyboard();
            }
        }
        
        inputs.forEach(input => {
            const pointSpan = document.createElement('span');
            pointSpan.className = 'decimal-point';
            pointSpan.textContent = '.';
            input.parentNode.insertBefore(pointSpan, input);
            
            input.addEventListener('focus', function() {
                activeInput = this;
                showKeyboard();
                
                if (this.value === '') {
                    this.value = '';
                }
            });
            
            input.addEventListener('blur', function() {
                const value = this.value;
                if (value && !value.includes('.')) {
                    this.value = value + '.00';
                } else if (value && value.endsWith('.')) {
                    this.value = value + '00';
                } else if (value && value.split('.')[1]?.length === 1) {
                    this.value = value + '0';
                }
            });
        });
        
        function hideKeyboard() {
            document.getElementById('keyboard').style.display = 'none';
            if (activeInput) {
                activeInput.blur();
                activeInput = null;
            }
        }
        
        function calculate() {
            // Получаем прематчевые данные
            const odds1 = parseFloat(document.getElementById('odds1').value) || 0;
            const odds2 = parseFloat(document.getElementById('odds2').value) || 0;
            const over17 = parseFloat(document.getElementById('over17').value) || 0;
            const under17 = parseFloat(document.getElementById('under17').value) || 0;
            const over18 = parseFloat(document.getElementById('over18').value) || 0;
            const under18 = parseFloat(document.getElementById('under18').value) || 0;
            const over19 = parseFloat(document.getElementById('over19').value) || 0;
            const under19 = parseFloat(document.getElementById('under19').value) || 0;
            
            // Получаем лайв данные
            const currentGame = parseInt(document.getElementById('currentGame').value) || 0;
            const liveOver17 = parseFloat(document.getElementById('live_over17').value) || 0;
            const liveUnder17 = parseFloat(document.getElementById('live_under17').value) || 0;
            const liveOver18 = parseFloat(document.getElementById('live_over18').value) || 0;
            const liveUnder18 = parseFloat(document.getElementById('live_under18').value) || 0;
            const liveOver19 = parseFloat(document.getElementById('live_over19').value) || 0;
            const liveUnder19 = parseFloat(document.getElementById('live_under19').value) || 0;
            
            // Рассчитываем маржу
            const margin = (1/odds1 + 1/odds2 - 1) * 100;
            
            // Рассчитываем вероятности без маржи
            const prob1 = (1/odds1) / (1 + margin/100) * 100;
            const prob2 = (1/odds2) / (1 + margin/100) * 100;
            
            // Выводим результаты
            let output = `<p>Маржа БК: <b>${margin.toFixed(2)}%</b></p>`;
            output += `<p>Реальные вероятности:</p>`;
            output += `<ul style="padding-left: 20px; margin: 5px 0;">
                <li>П1: ${prob1.toFixed(2)}%</li>
                <li>П2: ${prob2.toFixed(2)}%</li>
            </ul>`;
            
            if (currentGame > 0) {
                output += `<p style="margin-top: 8px;">Анализ на гейме ${currentGame}</p>`;
            }
            
            document.getElementById('output').innerHTML = output;
            document.getElementById('result').style.display = 'block';
            
            // Обновляем таблицу
            const table = document.getElementById('resultsTable');
            while (table.rows.length > 1) {
                table.deleteRow(1);
            }
            
            const values = [];
            const bestValues = [];
            
            // Добавляем исходы
            addRow(table, "П1", odds1, prob1, 0, values, bestValues);
            addRow(table, "П2", odds2, prob2, 0, values, bestValues);
            
            // Добавляем тоталы в таблицу
            addTotalRow(table, "Over 17.5", over17, liveOver17, currentGame, values, bestValues);
            addTotalRow(table, "Under 17.5", under17, liveUnder17, currentGame, values, bestValues);
            addTotalRow(table, "Over 18.5", over18, liveOver18, currentGame, values, bestValues);
            addTotalRow(table, "Under 18.5", under18, liveUnder18, currentGame, values, bestValues);
            addTotalRow(table, "Over 19.5", over19, liveOver19, currentGame, values, bestValues);
            addTotalRow(table, "Under 19.5", under19, liveUnder19, currentGame, values, bestValues);
            
            // Подсвечиваем лучшие value
            highlightBestValues(table, bestValues);
        }
        
        function addTotalRow(table, market, preOdds, liveOdds, currentGame, values, bestValues) {
            if (preOdds <= 0) return;
            
            const preProb = (1/preOdds) * 100;
            let liveProb = 0;
            let change = 0;
            let adjustedProb = preProb;
            let liveValue = 0;
            
            if (liveOdds > 0 && currentGame > 0) {
                liveProb = (1/liveOdds) * 100;
                change = liveProb - preProb;
                
                const liveWeight = Math.min(currentGame / 15, 0.7);
                adjustedProb = (liveProb * liveWeight) + (preProb * (1 - liveWeight));
                liveValue = (adjustedProb - preProb).toFixed(2);
            }
            
            const value = adjustedProb - preProb;
            values.push(value);
            
            if (value > 1) {
                bestValues.push({
                    value: value,
                    market: market,
                    odds: preOdds,
                    probability: adjustedProb,
                    change: change
                });
            }
            
            addRow(table, market, preOdds, adjustedProb, value, values, bestValues, change, liveProb);
        }
        
        function addRow(table, market, odds, probability, value, values, bestValues, change = null, liveProb = null) {
            const row = table.insertRow();
            
            row.insertCell(0).textContent = market;
            row.insertCell(1).textContent = odds.toFixed(2);
            
            const probCell = row.insertCell(2);
            if (liveProb !== null) {
                probCell.innerHTML = `
                    <div class="comparison-cell">
                        <span class="live-value">${probability.toFixed(2)}%</span>
                        <span class="prematch-value">${(probability - change).toFixed(2)}%</span>
                    </div>`;
            } else {
                probCell.textContent = probability.toFixed(2) + '%';
            }
            
            const valueCell = row.insertCell(3);
            valueCell.textContent = value.toFixed(2) + '%';
            
            if (value > 1) {
                valueCell.className = 'value-positive';
            } else if (value < -1) {
                valueCell.className = 'value-negative';
            }
            
            if (change !== null) {
                const changeCell = row.insertCell(4);
                const changeText = (change > 0 ? '+' : '') + change.toFixed(2) + '%';
                changeCell.textContent = changeText;
                
                if (change > 1) {
                    changeCell.className = 'change-positive';
                } else if (change < -1) {
                    changeCell.className = 'change-negative';
                }
            }
        }
        
        function highlightBestValues(table, bestValues) {
            if (bestValues.length === 0) return;
            
            bestValues.sort((a, b) => b.value - a.value);
            const topValues = bestValues.slice(0, 3);
            const topValueThreshold = topValues[topValues.length - 1].value;
            
            const rows = table.rows;
            for (let i = 1; i < rows.length; i++) {
                const cells = rows[i].cells;
                if (cells.length >= 4) {
                    const value = parseFloat(cells[3].textContent);
                    if (value >= topValueThreshold) {
                        rows[i].classList.add('best-value');
                    }
                }
            }
        }
        
        // Сохраняем прематчевые данные при переключении в лайв режим
        modeToggle.addEventListener('click', function() {
            if (prematchSection.style.display === 'none') {
                localStorage.setItem('prematchData', JSON.stringify({
                    odds1: document.getElementById('odds1').value,
                    odds2: document.getElementById('odds2').value,
                    over17: document.getElementById('over17').value,
                    under17: document.getElementById('under17').value,
                    over18: document.getElementById('over18').value,
                    under18: document.getElementById('under18').value,
                    over19: document.getElementById('over19').value,
                    under19: document.getElementById('under19').value
                }));
            }
        });
        
        // Загружаем сохраненные данные при загрузке страницы
        window.addEventListener('load', function() {
            const savedData = localStorage.getItem('prematchData');
            if (savedData) {
                const data = JSON.parse(savedData);
                for (const key in data) {
                    if (document.getElementById(key)) {
                        document.getElementById(key).value = data[key];
                    }
                }
            }
        });
    </script>
</body>
</html>
